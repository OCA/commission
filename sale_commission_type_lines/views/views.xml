<?xml version="1.0" encoding="utf-8" ?>
<odoo>
    <!-- Modified sale_commission views -->
    <record
        model="ir.ui.view"
        id="view_order_agent_form_inherit_sale_commission_type_lines_mod"
    >
        <field
            name="name"
        >sale.agent.order.inherit.form.sale_commission_type_lines.mod</field>
        <field name="model">sale.order</field>
        <field name="priority" eval="99" />
        <field name="inherit_id" ref="sale_commission.view_order_agent_form_inherit" />
        <field name="arch" type="xml">
            <button name="button_edit_agents" position="replace">
                <button
                    name="button_edit_agents"
                    icon="fa-users"
                    attrs="{'invisible': [('commission_free', '=', True)]}"
                    type="object"
                />
            </button>
        </field>
    </record>
    <record model="ir.ui.view" id="sale_commission_form_sale_commission_type_lines_mod">
        <field name="name">Sales commissions form sale_commission_type_lines</field>
        <field name="model">sale.commission</field>
        <field name="inherit_id" ref="sale_commission.sale_commission_form" />
        <field name="arch" type="xml">
            <field name="active" position="after">
                <field name="use_discount_in_ct_lines" invisible="1" />
            </field>
            <xpath expr="//field[@name='section_ids']/.." position="attributes">
                <attribute
                    name="attrs"
                >{'invisible': [('commission_type', '=', 'rules')]}</attribute>
            </xpath>
            <form position="inside">
                <group
                    string="Rules"
                    colspan="4"
                    attrs="{'invisible': [('commission_type', '!=', 'rules')]}"
                >
                    <field
                        name="item_ids"
                        nolabel="1"
                        context="{'hide_commission_id':1}"
                    >
                        <tree string="Items">
                            <field name="sequence" invisible="1" />
                            <field name="name" string="Applied On" />
                            <field name="commission_value" />
                            <field name="based_on" />
                            <field
                                name="discount_from"
                                attrs="{'column_invisible': [('parent.use_discount_in_ct_lines','=',False)]}"
                            />
                            <field
                                name="discount_to"
                                attrs="{'column_invisible': [('parent.use_discount_in_ct_lines','=',False)]}"
                            />
                        </tree>
                    </field>
                </group>
            </form>
        </field>
    </record>
    <record model="ir.ui.view" id="view_sale_order_line_tree_mod">
        <field name="name">sale.order.line.agent.mod</field>
        <field name="model">sale.order.line.agent</field>
        <field name="priority" eval="99" />
        <field name="inherit_id" ref="sale_commission.view_sale_order_line_tree" />
        <field name="arch" type="xml">
            <field name="commission_id" position="attributes">
                <attribute name="invisible">1</attribute>
            </field>
            <field name="amount" position="before">
                <field name="applied_on_name" string="Applied On" />
                <field name="based_on" string="Based On" />
                <field name="discount_from" string="Disc. From" invisible="1" />
                <field name="discount_to" string="Disc. To" invisible="1" />
                <field name="commission_type" string="Price Type" invisible="1" />
                <field name="fixed_amount" string="Amount (fixed)" invisible="1" />
                <field name="percent_amount" string="Amount (%)" invisible="1" />
                <field name="discount" string="Applied Disc. (%)" invisible="1" />
            </field>
            <field name="amount" position="replace">
                <field name="applied_commission_id" />
                <field
                    name="commission_ids"
                    string="Commissions"
                    widget="many2many_tags"
                    attrs="{'invisible': [('commission_ids', '=', False)]}"
                    invisible="1"
                />
                <field name="amount" string="Final Amount" />
            </field>
        </field>
    </record>
    <!-- New views -->
    <record id="commission_item_form_view" model="ir.ui.view">
        <field name="name">commission.item.form</field>
        <field name="model">commission.item</field>
        <field name="arch" type="xml">
            <form string="Commission Item">
                <sheet>
                    <h1>
                        <field name="name" />
                    </h1>
                    <group>
                        <group name="pricelist_rule_target">
                            <field name="company_id" invisible="1" />
                            <field
                                name="commission_id"
                                invisible="context.get('hide_commission_id')"
                            />
                            <field name="applied_on" widget="radio" />
                            <field
                                name="based_on"
                                attrs="{'invisible': [('parent.use_discount_in_ct_lines','=',False)]}"
                            />
                            <field name="use_pricelist" invisible="1" />
                            <field
                                name="categ_id"
                                attrs="{
                                      'invisible':[('applied_on', '!=', '2_product_category')],
                                      'required':[('applied_on', '=', '2_product_category')]}"
                                options="{'no_create':1}"
                            />
                            <field
                                name="product_tmpl_id"
                                attrs="{
                                        'invisible':[('applied_on', '!=', '1_product')],
                                        'required':[('applied_on', '=', '1_product')]}"
                                options="{'no_create':1}"
                            />
                            <field
                                name="product_id"
                                attrs="{
                                        'invisible':[('applied_on', '!=', '0_product_variant')],
                                        'required':[('applied_on', '=', '0_product_variant')]}"
                                options="{'no_create':1}"
                            />
                        </group>
                        <group
                            string="Commission by discount"
                            name="commission_by_discount"
                            attrs="{'invisible': [('based_on', '!=', 'discount')]}"
                        >
                            <field
                                name="discount_from"
                                attrs="{'required': [('discount_to', '>', 0)]}"
                                string="Discount From, %"
                            />
                            <field
                                name="discount_to"
                                attrs="{'required': [('discount_from', '>',0)]}"
                                string="Discount To, %"
                            />
                            <div class="text-muted" colspan="2">
                                Please note! "Discount From" must start from decimal
                                (e.g. 10.01).
                                <br />
                                Only exception is if "Discount From" is 0 (e.g. 0.00).
                            </div>
                        </group>
                    </group>
                    <group
                        string="Commission Computation"
                        name="commission_computation"
                        groups="sales_team.group_sale_manager"
                    >
                        <group name="commission_rule_method">
                            <field
                                name="commission_type"
                                string="Compute Price"
                                widget="radio"
                            />
                        </group>
                        <group name="commission_rule_base">
                            <field
                                name="fixed_amount"
                                attrs="{'invisible':[('commission_type', '!=', 'fixed')]}"
                            />
                            <label
                                for="percent_amount"
                                attrs="{'invisible':[('commission_type', '!=', 'percentage')]}"
                            />
                            <div
                                attrs="{'invisible':[('commission_type', '!=', 'percentage')]}"
                            >
                                <field
                                    name="percent_amount"
                                    class="oe_inline"
                                    attrs="{'invisible':[('commission_type', '!=', 'percentage')]}"
                                />
                                %%
                            </div>
                        </group>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

    <record id="commission_item_tree_view" model="ir.ui.view">
        <field name="name">commission.item.tree</field>
        <field name="model">commission.item</field>
        <field name="arch" type="xml">
            <tree string="Commission Items">
                <field name="commission_id" />
                <field name="applied_on" />
                <field name="use_pricelist" invisible="1" />
                <field name="commission_value" />
                <field name="based_on" />
                <field name="discount_from" />
                <field name="discount_to" />
            </tree>
        </field>
    </record>

    <record id="commission_item_search" model="ir.ui.view">
        <field name="name">commission.item.search.view</field>
        <field name="model">commission.item</field>
        <field name="arch" type="xml">
            <search string="Commission Items">
                <field name="commission_id" />
                <group expand="0" string="Group By">
                    <filter
                        string="Commission"
                        name="group_by_commission"
                        domain="[]"
                        context="{'group_by' : 'commission_id'}"
                    />
                </group>
            </search>
        </field>
    </record>

    <record id="commission_item_action" model="ir.actions.act_window">
        <field name="name">Commission Items</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">commission.item</field>
        <field name="view_mode">tree,form</field>
        <field name="context">
            {"hide_commission_id":1, 'search_default_group_by_commission': 1,}
        </field>
    </record>

    <record id="commission_item_action_tree" model="ir.actions.act_window">
        <field name="name">Commission Items</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">commission.item</field>
        <field name="view_mode">tree,form</field>
        <field name="context">
            {"hide_commission_id":0, 'search_default_group_by_commission': 1,}
        </field>
        <field
            name="view_ids"
            eval="[(5, 0, 0),
            (0, 0, {'view_mode': 'tree', 'view_id': ref('commission_item_tree_view')}),
            (0, 0, {'view_mode': 'form', 'view_id': ref('commission_item_form_view')})]"
        />
    </record>

    <menuitem
        name="Commission Items"
        id="menu_sale_commissions_items"
        action="commission_item_action_tree"
        parent="sale_commission.menu_sale_commissions_management"
        groups="sales_team.group_sale_manager"
        sequence="10"
    />
</odoo>
